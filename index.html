<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Pro | è¡Œæ”¿ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }

        /* --- Hoover æ•ˆæœå¼·åŒ– --- */
        .fc-event {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            cursor: zoom-in !important; /* é¼ æ¨™æ”¹è®Š */
            z-index: 1;
        }
        .fc-event:hover {
            transform: scale(1.05); /* é …ç›®ç¨å¾®è®Šå¤§ */
            z-index: 50 !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2) !important;
        }

        /* --- æ’ç‰ˆèˆ‡å­—é«”å„ªåŒ– --- */
        .fc-v-event { border: none !important; border-left: 4px solid rgba(0,0,0,0.2) !important; border-radius: 8px !important; }
        .fc-event-main { padding: 3px 5px !important; display: flex !important; flex-direction: column !important; justify-content: center !important; line-height: 1.1 !important; overflow: visible !important; }
        .fc-event-title { font-size: 11px !important; font-weight: 700 !important; white-space: normal !important; padding-bottom: 2px !important; }
        .fc-event-time { font-size: 10px !important; font-weight: 700; opacity: 0.8; margin-bottom: 1px; }

        /* å°èˆªæ¨™é¡Œ */
        .fc .fc-nav-link { color: #4f46e5 !important; font-weight: bold; }

        /* éš±è—é è¨­ Swal æŒ‰éˆ•ä»¥ä½¿ç”¨è‡ªå®šç¾©æŒ‰éˆ• */
        .swal2-actions { margin-top: 1.5rem !important; }

        #loadingOverlay { 
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); 
            backdrop-filter: blur(4px); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body>

<div id="loadingOverlay" style="display:none;">
    <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-black text-indigo-600 text-sm">æ­£åœ¨åŒæ­¥é›²ç«¯...</p>
</div>

<div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="flex justify-between items-center mb-6 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg shadow-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
            </div>
            <h1 class="text-xl font-black text-slate-800">è¨ºæ‰€è¡Œæ”¿ç³»çµ± Pro</h1>
        </div>
        <button onclick="init(true)" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-5 py-2 rounded-xl text-sm font-bold transition">åˆ·æ–°æ’ç¨‹</button>
    </header>

    <div class="bg-white p-2 md:p-4 rounded-[2.5rem] shadow-2xl border border-white">
        <div id="calendar"></div>
    </div>
</div>

<!-- æ–°å¢é ç´„ Modal (ç•¥, èˆ‡å‰ç‰ˆæœ¬ç›¸åŒ) -->
<div id="bookingModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[200] flex justify-center items-center p-4">
    <!-- ... é ç´„è¡¨å–®å…§å®¹ ... -->
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyFhdESVFhovTJrT5NsrufXxRw1l4VLE_3U5NIFDJi-RV2n4bbq68YzGspNZYHEYsi3XA/exec"; 
    let calendar;
    let db = { appointments: [], therapists: [], treatments: [] };

    document.addEventListener('DOMContentLoaded', () => init(false));

    async function init(isRefresh = false) {
        let savedDate = calendar ? calendar.getDate() : null;
        let savedView = calendar ? calendar.view.type : null;
        showLoading(true);
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
            db = await resp.json();
            populateDropdowns();
            renderCalendar(savedDate, savedView);
        } catch (e) { console.error(e); }
        showLoading(false);
    }

    function renderCalendar(savedDate, savedView) {
        const calendarEl = document.getElementById('calendar');
        if (calendar) calendar.destroy();
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: savedView || 'timeGridWeek',
            initialDate: savedDate || new Date(),
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay,dayGridMonth' },
            locale: 'zh-tw',
            slotMinTime: '08:00:00',
            slotMaxTime: '21:00:00',
            allDaySlot: false,
            height: 'auto',
            selectable: true,
            navLinks: true,
            nowIndicator: true,
            select: function(info) { openModal(info.startStr.split('T')[0], info.startStr.split('T')[1].substring(0,5)); },
            eventClick: function(info) {
                const app = info.event.extendedProps;
                showCheckInModal(app);
            },
            events: formatEvents(db.appointments)
        });
        calendar.render();
    }

    // --- é‡æ•´å ±åˆ°è¦–çª—èˆ‡æŒ‰éˆ•åŠŸèƒ½ ---
    function showCheckInModal(app) {
        Swal.fire({
            title: `<span class="text-xl font-black">æ‚£è€…ï¼š${app.patient}</span>`,
            html: `
                <div class="text-left text-sm bg-slate-50 p-4 rounded-2xl mb-6 space-y-1">
                    <p><b>ğŸ©º é …ç›®ï¼š</b> ${app.item}</p>
                    <p><b>ğŸ‘¤ æ²»ç™‚å¸«ï¼š</b> ${app.therapist}</p>
                    <p><b>ğŸ’° é‡‘é¡ï¼š</b> $${app.fee}</p>
                    <p><b>ğŸ“ ç›®å‰ç‹€æ…‹ï¼š</b> <span class="text-indigo-600 font-bold">${app.status}</span></p>
                    <p><b>ğŸ“ å‚™è¨»ï¼š</b> <span id="modal-notes-text">${app.notes || 'ç„¡'}</span></p>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button id="btn-done" class="bg-emerald-500 text-white p-3 rounded-xl text-xs font-bold hover:bg-emerald-600">å ±åˆ°ç¹³è²»</button>
                    <button id="btn-cancel-check" class="bg-slate-200 text-slate-600 p-3 rounded-xl text-xs font-bold hover:bg-slate-300">å–æ¶ˆå ±åˆ°</button>
                    <button id="btn-leave" class="bg-amber-500 text-white p-3 rounded-xl text-xs font-bold hover:bg-amber-600">è«‹å‡</button>
                    <button id="btn-edit-note" class="bg-indigo-500 text-white p-3 rounded-xl text-xs font-bold hover:bg-indigo-600">ç·¨è¼¯å‚™è¨»</button>
                    <button id="btn-delete" class="bg-rose-500 text-white p-3 rounded-xl text-xs font-bold hover:bg-rose-600">åˆªé™¤</button>
                    <button id="btn-close" class="bg-slate-400 text-white p-3 rounded-xl text-xs font-bold">é—œé–‰</button>
                </div>
            `,
            showConfirmButton: false, // éš±è—é è¨­æŒ‰éˆ•
            didOpen: () => {
                // 1. å ±åˆ°ç¹³è²»
                document.getElementById('btn-done').onclick = () => { Swal.close(); handleUpdate(app.id, 'å·²å®Œæˆ'); };
                // 2. å–æ¶ˆå ±åˆ° (æ¢å¾©ç‚ºå·²é ç´„)
                document.getElementById('btn-cancel-check').onclick = () => { Swal.close(); handleUpdate(app.id, 'å·²é ç´„'); };
                // 3. è«‹å‡
                document.getElementById('btn-leave').onclick = () => { Swal.close(); handleUpdate(app.id, 'è«‹å‡'); };
                // 4. ç·¨è¼¯å‚™è¨»
                document.getElementById('btn-edit-note').onclick = () => { handleEditNotes(app); };
                // 5. åˆªé™¤
                document.getElementById('btn-delete').onclick = () => { Swal.close(); handleDelete(app.id); };
                // é—œé–‰
                document.getElementById('btn-close').onclick = () => { Swal.close(); };
            }
        });
    }

    async function handleEditNotes(app) {
        const { value: text } = await Swal.fire({
            title: 'ç·¨è¼¯å‚™è¨»',
            input: 'textarea',
            inputLabel: 'è«‹è¼¸å…¥æ–°çš„å‚™è¨»å…§å®¹',
            inputValue: app.notes || '',
            showCancelButton: true
        });
        if (text !== undefined) {
            showLoading(true);
            await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'updateNotes', id: app.id, notes: text }) 
            });
            init(true);
        }
    }

    // --- å…¶ä»–åŸæœ‰åŠŸèƒ½ ---
    function formatEvents(apps) {
        return apps.map(a => {
            const v = Object.values(a);
            const dateStr = a['æ—¥æœŸ'] || v[1];
            const timeStr = a['æ™‚é–“'] || v[2];
            if(!dateStr || !timeStr) return null;
            const cleanDate = dateStr.toString().replace(/\//g, '-');
            const cleanTime = timeStr.toString().substring(0, 5);
            const status = a['ç‹€æ…‹'] || v[7];
            
            let color = '#4f46e5'; // é è¨­è— (å·²é ç´„)
            if (status === 'å·²å®Œæˆ') color = '#10b981'; // ç¶ 
            if (status === 'è«‹å‡') color = '#f59e0b'; // æ©˜

            return {
                id: a['ID'] || v[0],
                title: `${a['æ‚£è€…å§“å'] || v[3]} / ${a['é …ç›®åç¨±'] || v[5]}`,
                start: `${cleanDate}T${cleanTime}:00`,
                end: moment(`${cleanDate}T${cleanTime}:00`).add(50, 'minutes').format('YYYY-MM-DDTHH:mm:ss'),
                backgroundColor: color,
                extendedProps: {
                    patient: a['æ‚£è€…å§“å'] || v[3],
                    therapist: a['æ²»ç™‚å¸«'] || v[4],
                    item: a['é …ç›®åç¨±'] || v[5],
                    fee: a['å¯¦æ”¶è²»ç”¨'] || v[6],
                    notes: a['å‚™è¨»'] || v[9],
                    status: status,
                    id: a['ID'] || v[0]
                }
            };
        }).filter(e => e !== null);
    }

    async function handleUpdate(id, status) {
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id, status }) });
        init(true);
    }

    async function handleDelete(id) {
        const result = await Swal.fire({ title: 'ç¢ºèªåˆªé™¤ï¼Ÿ', icon: 'warning', showCancelButton: true });
        if (result.isConfirmed) {
            showLoading(true);
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
            init(true);
        }
    }

    // (populateDropdowns, updatePrice, openModal, closeModal ç­‰å‡½æ•¸ç¶­æŒä¸è®Š)
    function showLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
