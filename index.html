<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Pro | å°ˆæ¥­æ’ç¨‹ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- å¼•å…¥ moment è™•ç†æ™‚é–“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        /* --- Hoover åŠŸèƒ½ç¾åŒ– --- */
        .fc-timegrid-slot {
            transition: all 0.2s;
            position: relative;
        }
        .fc-timegrid-slot:hover {
            background-color: #f0f7ff !important;
            box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.1);
            cursor: pointer;
        }
        .fc-timegrid-slot:hover::after {
            content: '+ æ–°å¢é ç´„';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #3b82f6;
            font-weight: bold;
            opacity: 0.6;
        }

        /* --- æœˆæ›†äº‹ä»¶ç¾åŒ– --- */
        .fc-v-event {
            border: none !important;
            border-left: 4px solid rgba(0,0,0,0.2) !important;
            border-radius: 8px !important;
            padding: 4px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        }
        .fc-event-title { font-weight: 700 !important; font-size: 13px; }
        .fc-event-time { font-size: 11px; opacity: 0.9; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

<div id="loadingOverlay">
    <div class="animate-bounce mb-4 text-4xl">ğŸ—“ï¸</div>
    <div class="text-indigo-600 font-black tracking-widest animate-pulse">SYSTEM LOADING...</div>
</div>

<div class="max-w-7xl mx-auto p-4">
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200 mt-4">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-600 p-3 rounded-2xl shadow-indigo-200 shadow-lg text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Clinic Pro <span class="text-indigo-600">Scheduler</span></h1>
                <div id="connectionStatus" class="flex items-center text-xs text-green-500 font-bold uppercase tracking-wider">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-ping"></span> é€£ç·šä¸­
                </div>
            </div>
        </div>
        <nav class="flex p-1 bg-slate-100 rounded-2xl mt-4 md:mt-0">
            <button onclick="showTab('calendar-view')" class="px-6 py-2 rounded-xl bg-white text-indigo-600 font-bold shadow-sm transition">æœˆæ›†çœ‹æ¿</button>
            <button onclick="showTab('stats-view')" class="px-6 py-2 rounded-xl text-slate-500 font-bold hover:text-indigo-600 transition">æ¥­ç¸¾å ±è¡¨</button>
        </nav>
    </header>

    <main id="calendar-view" class="tab-content active">
        <div class="bg-white p-6 rounded-[2.5rem] shadow-2xl shadow-slate-200 border border-white">
            <div id="calendar"></div>
        </div>
    </main>

    <!-- çµ±è¨ˆä»‹é¢ (ç°¡åŒ–é¡¯ç¤º) -->
    <main id="stats-view" class="tab-content">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl">
            <h2 class="text-2xl font-bold mb-6">çµ±è¨ˆå ±å‘Š (é–‹ç™¼ä¸­...)</h2>
        </div>
    </main>
</div>

<!-- æ–°å¢é ç´„ Modal -->
<div id="bookingModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md z-50 flex justify-center items-center p-4">
    <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-white">
        <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
            <h3 class="text-xl font-bold">æ–°é ç´„ç™»è¨˜</h3>
            <button onclick="closeModal()" class="text-white/80 hover:text-white">âœ•</button>
        </div>
        <form id="bookingForm" class="p-8 space-y-5">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">é ç´„æ—¥æœŸ</label>
                    <input type="date" id="formDate" required class="w-full bg-slate-50 border-none p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">èµ·å§‹æ™‚é–“</label>
                    <input type="time" id="formTime" required class="w-full bg-slate-50 border-none p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">æ‚£è€…å§“å</label>
                <input type="text" id="formName" required placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" class="w-full bg-slate-50 border-none p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">æ²»ç™‚å¸«</label>
                    <select id="formTherapist" required class="w-full bg-slate-50 border-none p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">é …ç›®</label>
                    <select id="formItem" onchange="updatePrice()" required class="w-full bg-slate-50 border-none p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">æ”¶è²»é‡‘é¡</label>
                <input type="number" id="formFee" required class="w-full bg-indigo-50 border-none p-3 rounded-xl font-bold text-indigo-700 outline-none">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">å‚™è¨»</label>
                <textarea id="formNotes" class="w-full bg-slate-50 border-none p-3 rounded-xl h-20 outline-none text-sm" placeholder="è¼¸å…¥ç‰¹æ®Šéœ€æ±‚..."></textarea>
            </div>
            <button type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition transform hover:-translate-y-1">ç¢ºèªé ç´„</button>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwRKHVzuYXtOpl188khy-J9mNwQYpeT5EPSmmugdU0nY_BIkjCj_nD7jXefgHMaoxtokQ/exec"; 
    let calendar;
    let db = { appointments: [], therapists: [], treatments: [] };

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        showLoading(true);
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
            db = await resp.json();
            
            console.log("å¾é›²ç«¯è¼‰å…¥çš„è³‡æ–™:", db.appointments); // åµéŒ¯ç”¨

            document.getElementById('formTherapist').innerHTML = db.therapists.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            document.getElementById('formItem').innerHTML = db.treatments.map(i => `<option value="${i.name}">${i.name}</option>`).join('');

            renderCalendar();
        } catch (e) {
            Swal.fire('Error', 'ç„¡æ³•è®€å–è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ API URL', 'error');
        }
        showLoading(false);
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (calendar) calendar.destroy();

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
            locale: 'zh-tw',
            slotMinTime: '08:00:00',
            slotMaxTime: '22:00:00',
            allDaySlot: false,
            height: 'auto',
            navLinks: true,
            selectable: true,
            nowIndicator: true,
            select: function(info) {
                openModal(info.startStr.split('T')[0], info.startStr.split('T')[1].substring(0,5));
            },
            eventClick: function(info) {
                const app = info.event.extendedProps;
                Swal.fire({
                    title: `æ‚£è€…: ${app.patient}`,
                    html: `<div class='text-left text-sm space-y-1'>
                           <p>ğŸ“‹ é …ç›®: ${app.item}</p>
                           <p>ğŸ§‘â€âš•ï¸ æ²»ç™‚å¸«: ${app.therapist}</p>
                           <p>ğŸ’° é‡‘é¡: $${app.fee}</p>
                           <p>ğŸ“ å‚™è¨»: ${app.notes || 'ç„¡'}</p>
                           <p>ğŸ“ ç‹€æ…‹: ${app.status}</p></div>`,
                    showDenyButton: true,
                    confirmButtonText: 'å®Œæˆæ²»ç™‚',
                    denyButtonText: 'åˆªé™¤é ç´„'
                }).then(async (result) => {
                    if (result.isConfirmed) updateStatus(app.id, 'å·²å®Œæˆ');
                    else if (result.isDenied) deleteApp(app.id);
                });
            },
            // å°‡äº‹ä»¶æ¸²æŸ“åˆ°æœˆæ›†
            events: formatEvents(db.appointments)
        });
        calendar.render();
    }

    function formatEvents(apps) {
        return apps.map(a => {
            // æ‹¼æ¥ ISO 8601 æ™‚é–“æ ¼å¼: YYYY-MM-DDTHH:mm:ss
            // å¼·åˆ¶æ ¼å¼æª¢æŸ¥
            const startTime = `${a.æ—¥æœŸ}T${a.æ™‚é–“}:00`;
            const isValid = moment(startTime).isValid();
            
            if(!isValid) {
                console.warn("è·³éç„¡æ•ˆé ç´„è³‡æ–™:", a);
                return null;
            }

            return {
                id: a.ID,
                title: `${a.æ‚£è€…å§“å} (${a.æ²»ç™‚å¸«})`,
                start: startTime,
                end: moment(startTime).add(50, 'minutes').format('YYYY-MM-DDTHH:mm:ss'),
                backgroundColor: a.ç‹€æ…‹ === 'å·²å®Œæˆ' ? '#10b981' : '#4f46e5',
                extendedProps: {
                    patient: a.æ‚£è€…å§“å,
                    therapist: a.æ²»ç™‚å¸«,
                    item: a.é …ç›®,
                    status: a.ç‹€æ…‹,
                    fee: a.è²»ç”¨,
                    notes: a.å‚™è¨»,
                    id: a.ID
                }
            };
        }).filter(e => e !== null);
    }

    // Modal èˆ‡ API äº’å‹• (åŒä¸Šå€‹ç‰ˆæœ¬ï¼Œä½†ç¢ºä¿ add æ™‚åŒ…å« notes)
    async function updateStatus(id, status) {
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id, status }) });
        await init();
    }

    async function deleteApp(id) {
        if(!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
        await init();
    }

    function openModal(date, time) {
        document.getElementById('formDate').value = date;
        document.getElementById('formTime').value = time;
        document.getElementById('bookingModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('bookingModal').classList.add('hidden');
    }

    function updatePrice() {
        const item = db.treatments.find(i => i.name === document.getElementById('formItem').value);
        if (item) document.getElementById('formFee').value = item.price;
    }

    document.getElementById('bookingForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            date: document.getElementById('formDate').value,
            time: document.getElementById('formTime').value,
            name: document.getElementById('formName').value,
            therapist: document.getElementById('formTherapist').value,
            item: document.getElementById('formItem').value,
            fee: document.getElementById('formFee').value,
            notes: document.getElementById('formNotes').value
        };
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', data }) });
        closeModal();
        await init();
        Swal.fire('é ç´„æˆåŠŸ', '', 'success');
    };

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(calendar) calendar.render();
    }

    function showLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
