<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Pro | è¡Œæ”¿ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }

/* --- ä¿®æ­£å­—é«”è£åˆ‡èˆ‡æ’ç‰ˆå•é¡Œçš„çµ‚æ¥µ CSS --- */

/* 1. äº‹ä»¶å®¹å™¨ï¼šç¢ºä¿ä¸æº¢å‡ºä¸¦å‚ç›´ç½®ä¸­ */
.fc-v-event {
    border-radius: 6px !important;
    border: none !important;
    border-left: 4px solid rgba(0,0,0,0.2) !important; /* å·¦å´æ·±è‰²æ¢ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.fc-event-main {
    padding: 2px 4px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important; /* æ ¸å¿ƒï¼šå‚ç›´ç½®ä¸­ */
    line-height: 1.1 !important; /* æ¥µçª„è¡Œé«˜é˜²æ­¢åº•éƒ¨è£åˆ‡ */
    overflow: hidden !important;
}

/* 2. æ™‚é–“æ¨™ç±¤ (å¦‚ ä¸‹åˆ12:30)ï¼šç¸®å°å­—é«” */
.fc-event-time {
    font-size: 10px !important; /* ç¸®å°æ™‚é–“å­—é«” */
    font-weight: 500 !important;
    margin-bottom: 1px !important;
    opacity: 0.9;
    white-space: nowrap !important;
}

/* 3. æ¨™é¡Œå…§å®¹ (å§“å / é …ç›®)ï¼šå¾®èª¿å­—ç´š */
.fc-event-title {
    font-size: 11px !important; /* ç¨å¾®ç¸®å°å­—é«”ä»¥å¡é€²æ›´å¤šå­— */
    font-weight: 700 !important;
    color: #ffffff !important;
    display: block !important;
    white-space: normal !important; /* å…è¨±æ›è¡Œ */
    word-break: break-all !important; /* é¿å…é•·å­—è¡å‡ºæ¡†æ¡† */
    overflow: hidden !important;
    text-overflow: ellipsis; /* å¤ªé•·é¡¯ç¤º... */
    padding-bottom: 2px !important; /* çµ¦æ–‡å­—åº•ä¸‹çš„ descender (å¦‚'j','p'æˆ–ä¸­æ–‡ç­†ç•«) ç•™ç©ºé–“ */
}

/* 4. é‡å° 50 åˆ†é˜æ™‚æ®µå¼·åˆ¶æœ€å°é«˜åº¦ */
.fc-timegrid-event {
    min-height: 55px !important; 
}

/* 5. å„ªåŒ–æœˆæ›†æ ¼å­çš„æ»‘éæ•ˆæœ */
.fc-timegrid-slot:hover {
    background-color: #f0f9ff !important;
    cursor: crosshair;
}

        #loadingOverlay { 
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); 
            backdrop-filter: blur(4px); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

<div id="loadingOverlay" style="display:none;">
    <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-black text-indigo-600 tracking-widest text-sm">åŒæ­¥è³‡æ–™ä¸­...</p>
</div>

<div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-800">è¨ºæ‰€è¡Œæ”¿ç³»çµ± <span class="text-indigo-600">Pro</span></h1>
            </div>
        </div>
        <div class="flex gap-2 mt-4 md:mt-0">
            <button onclick="init(true)" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold transition">åˆ·æ–°åŒæ­¥</button>
            <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg transition">å¿«é€Ÿé ç´„</button>
        </div>
    </header>

    <div class="bg-white p-2 md:p-4 rounded-[2.5rem] shadow-2xl border border-white">
        <div id="calendar"></div>
    </div>
</div>

<!-- é ç´„ Modal -->
<div id="bookingModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex justify-center items-center p-4">
    <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
        <div class="bg-indigo-600 px-8 py-6 text-white flex justify-between items-center">
            <h3 class="text-xl font-bold">æ–°æ’ç¨‹ç™»è¨˜</h3>
            <button onclick="closeModal()" class="w-8 h-8 rounded-full flex items-center justify-center transition">âœ•</button>
        </div>
        <form id="bookingForm" class="p-8 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <input type="date" id="formDate" required class="bg-slate-50 border-none p-3 rounded-2xl outline-none text-sm focus:ring-2 focus:ring-indigo-500">
                <input type="time" id="formTime" required class="bg-slate-50 border-none p-3 rounded-2xl outline-none text-sm focus:ring-2 focus:ring-indigo-500">
            </div>
            <input type="text" id="formName" required placeholder="æ‚£è€…å§“å" class="w-full bg-slate-50 border-none p-3 rounded-2xl outline-none text-sm focus:ring-2 focus:ring-indigo-500">
            <div class="grid grid-cols-2 gap-4">
                <select id="formTherapist" required class="w-full bg-slate-50 border-none p-3 rounded-2xl outline-none text-sm focus:ring-2 focus:ring-indigo-500"></select>
                <select id="formItem" onchange="updatePrice()" required class="w-full bg-slate-50 border-none p-3 rounded-2xl outline-none text-sm focus:ring-2 focus:ring-indigo-500"></select>
            </div>
            <input type="number" id="formFee" required placeholder="æ”¶è²»é‡‘é¡" class="w-full bg-indigo-50 border-none p-3 rounded-2xl font-bold text-indigo-700 outline-none">
            <textarea id="formNotes" class="w-full bg-slate-50 border-none p-3 rounded-2xl h-20 outline-none text-sm" placeholder="å‚™è¨»è³‡è¨Š..."></textarea>
            <button type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-xl hover:bg-indigo-700 transition">ç¢ºèªé ç´„</button>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz1Lkspl8yY3Jx1E_KcFxg583KYFKnMGQ4i4kQJanfsmhYHiX91q9hrGCErYmMYZspvRQ/exec"; 
    let calendar;
    let db = { appointments: [], therapists: [], treatments: [] };

    document.addEventListener('DOMContentLoaded', () => init(false));

    async function init(isRefresh = false) {
        // 1. è¨˜ä½ç•¶å‰ä½ç½®
        let currentScrollDate = null;
        let currentView = 'timeGridWeek';
        if (calendar) {
            currentScrollDate = calendar.getDate();
            currentView = calendar.view.type;
        }

        showLoading(true);
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
            db = await resp.json();
            
            // 2. ä¿®æ­£é¸å–®æŠ“ä¸åˆ°è³‡æ–™çš„å•é¡Œ (è‡ªå‹•æª¢ç´¢å¤šå€‹å¯èƒ½çš„æ¬„ä½åç¨±)
            populateDropdowns();

            // 3. æ¸²æŸ“æœˆæ›†ä¸¦å›åˆ°å‰›æ‰çš„ä½ç½®
            renderCalendar(currentScrollDate, currentView);
        } catch (e) {
            Swal.fire('Error', 'é€£ç·šå¤±æ•—', 'error');
        }
        showLoading(false);
    }

function populateDropdowns() {
    // æ²»ç™‚å¸«ä¸‹æ‹‰ (å‡è¨­æ¨™é¡Œæ˜¯ã€Œå§“åã€)
    const tSelect = document.getElementById('formTherapist');
    tSelect.innerHTML = '<option value="">é¸æ“‡æ²»ç™‚å¸«</option>' + 
        db.therapists.map(t => `<option value="${t['å§“å']}">${t['å§“å']}</option>`).join('');

    // é …ç›®ä¸‹æ‹‰ (ç¢ºä¿æŠ“çš„æ˜¯ã€Œé …ç›®åç¨±ã€)
    const iSelect = document.getElementById('formItem');
    iSelect.innerHTML = '<option value="">é¸æ“‡é …ç›®</option>' + 
        db.treatments.map(i => `<option value="${i['é …ç›®åç¨±']}">${i['é …ç›®åç¨±']}</option>`).join('');
}

    function renderCalendar(savedDate, savedView) {
        const calendarEl = document.getElementById('calendar');
        if (calendar) calendar.destroy();

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: savedView || 'timeGridWeek',
            initialDate: savedDate || new Date(), // é€™è¡Œç¢ºä¿åœåœ¨åŸé é¢
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay,dayGridMonth' },
            locale: 'zh-tw',
            slotMinTime: '08:00:00',
            slotMaxTime: '21:00:00',
            allDaySlot: false,
                slotDuration: '00:15:00', 
    slotLabelInterval: '01:00', // å·¦å´æ¨™ç±¤ç¶­æŒä¸€å°æ™‚ä¸€å€‹
    expandRows: true,
            height: 'auto',
            selectable: true,
            nowIndicator: true,
            select: function(info) {
                openModal(info.startStr.split('T')[0], info.startStr.split('T')[1].substring(0,5));
            },
            eventClick: function(info) {
                const app = info.event.extendedProps;
                Swal.fire({
                    title: `æ‚£è€…: ${app.patient}`,
                    html: `<div class='text-left text-sm p-3 bg-slate-50 rounded-xl space-y-2 mt-2'>
                           <p>ğŸ“‹ é …ç›®: ${app.item}</p>
                           <p>ğŸ§‘â€âš•ï¸ è² è²¬: ${app.therapist}</p>
                           <p>ğŸ’° é‡‘é¡: $${app.fee}</p>
                           <p>ğŸ“ å‚™è¨»: ${app.notes || 'ç„¡'}</p></div>`,
                    showDenyButton: true,
                    confirmButtonText: 'âœ”ï¸ å®Œæˆæ²»ç™‚',
                    denyButtonText: 'âŒ åˆªé™¤é ç´„'
                }).then(async (result) => {
                    if (result.isConfirmed) handleUpdate(app.id, 'å·²å®Œæˆ');
                    else if (result.isDenied) handleDelete(app.id);
                });
            },
            events: formatEvents(db.appointments)
        });
        calendar.render();
    }

function formatEvents(apps) {
    if (!apps || apps.length === 0) return [];

    return apps.map((a) => {
        const values = Object.values(a);
        
        // æ ¹æ“šæ¬„ä½é †åºæŠ“å– (è«‹ç¢ºä¿é †åºæ­£ç¢º)
        const id = a['ID'] || values[0];
        const dateStr = a['æ—¥æœŸ'] || values[1];
        const timeStr = a['æ™‚é–“'] || values[2];
        const patientName = a['æ‚£è€…å§“å'] || values[3];
        const therapistName = a['æ²»ç™‚å¸«'] || values[4];
        const itemName = a['é …ç›®åç¨±'] || values[5];
        const fee = a['å¯¦æ”¶è²»ç”¨'] || values[6];
        const status = a['ç‹€æ…‹'] || values[7];
        const notes = a['å‚™è¨»'] || values[9];

        if (!dateStr || !timeStr) return null;

        // æ ¼å¼åŒ–æ—¥æœŸèˆ‡æ™‚é–“ (æ”¯æ´ 2024/01/01 æˆ– 2024-01-01)
        const cleanDate = dateStr.toString().replace(/\//g, '-').trim();
        const cleanTime = timeStr.toString().substring(0, 5).trim();
        const startISO = `${cleanDate}T${cleanTime}:00`;

        return {
            id: id,
            // æ¨™é¡Œå„ªåŒ–ï¼šåªä¿ç•™æœ€é‡è¦çš„å…©é …ï¼Œæ¸›å°‘å‚ç›´ä½”ç”¨ç©ºé–“
            title: `${patientName} / ${itemName}`, 
            start: startISO,
            // ç™‚ç¨‹è¨­å®šç‚º 50 åˆ†é˜
            end: moment(startISO).add(50, 'minutes').format('YYYY-MM-DDTHH:mm:ss'),
            backgroundColor: status === 'å·²å®Œæˆ' ? '#10b981' : '#4f46e5',
            extendedProps: {
                patient: patientName,
                therapist: therapistName,
                item: itemName,
                fee: fee,
                notes: notes,
                status: status,
                id: id
            }
        };
    }).filter(e => e !== null);
}
    
    function calculateEndTime(startTime) {
        let [h, m] = startTime.split(':').map(Number);
        m += 50; if (m >= 60) { h += 1; m -= 60; }
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

function updatePrice() {
    const selectedName = document.getElementById('formItem').value;
    if (!selectedName) return;

    // åœ¨ db.treatments ä¸­å°‹æ‰¾
    const itemEntry = db.treatments.find(i => {
        const name = i['é …ç›®åç¨±'] || Object.values(i)[0];
        return name === selectedName;
    });

    if (itemEntry) {
        // æŠ“å– Treatments åˆ†é ä¸­çš„ç¬¬äºŒæ¬„ã€Œé è¨­æ”¶è²»ã€
        const price = itemEntry['é è¨­æ”¶è²»'] || Object.values(itemEntry)[1];
        document.getElementById('formFee').value = price;
    }
}
    // Modal èˆ‡ API äº’å‹•
    function openModal(date = '', time = '') {
        document.getElementById('bookingForm').reset();
        if(date) document.getElementById('formDate').value = date;
        if(time) document.getElementById('formTime').value = time;
        document.getElementById('bookingModal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('bookingModal').classList.add('hidden'); }

    document.getElementById('bookingForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            date: document.getElementById('formDate').value,
            time: document.getElementById('formTime').value,
            name: document.getElementById('formName').value,
            therapist: document.getElementById('formTherapist').value,
            item: document.getElementById('formItem').value,
            fee: document.getElementById('formFee').value,
            notes: document.getElementById('formNotes').value
        };
        closeModal();
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', data }) });
        init(true); // åˆ·æ–°ä¸¦ä¿æŒä½ç½®
    };

    async function handleUpdate(id, status) {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id, status }) });
        init(true);
    }

    async function handleDelete(id) {
        if(!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
        init(true);
    }

    function showLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
