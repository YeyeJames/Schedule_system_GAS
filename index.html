<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Pro | è¡Œæ”¿ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; }

/* --- è§£æ±ºå­—é«”è£åˆ‡èˆ‡é¡¯ç¤ºå•é¡Œçš„çµ‚æ¥µæ–¹æ¡ˆ --- */

/* 1. è¨­å®šæ‰€æœ‰äº‹ä»¶æ ¼å­çš„æœ€å°é«˜åº¦ï¼Œç¢ºä¿ 50 åˆ†é˜çš„é ç´„ä¸æœƒå¤ªæ‰ */
.fc-timegrid-event {
    min-height: 45px !important; 
    margin-bottom: 1px !important;
}

/* 2. èª¿æ•´äº‹ä»¶å…§éƒ¨å®¹å™¨ */
.fc-event-main {
    padding: 2px 4px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important; /* å‚ç›´ç½®ä¸­ */
    overflow: visible !important; /* å…è¨±æ–‡å­—é¡¯ç¤ºå®Œæ•´ */
}

/* 3. èª¿æ•´æ™‚é–“é¡¯ç¤º (ä¸Šåˆ10:00é‚£è¡Œ) */
.fc-event-time {
    font-size: 10px !important;
    line-height: 1 !important;
    margin-bottom: 2px !important;
    opacity: 0.85;
    font-weight: 500;
}

/* 4. èª¿æ•´æ¨™é¡Œé¡¯ç¤º (å§“åèˆ‡é …ç›®é‚£è¡Œ) */
.fc-event-title {
    font-size: 12px !important; /* ç•¥å¾®ç¸®å°å­—é«”ä»¥é©æ‡‰å¯¬åº¦ */
    line-height: 1.1 !important; /* ç¸®å°è¡Œé«˜ï¼Œè®“å…©è¡Œå­—èƒ½å¡é€²å°æ ¼å­ */
    font-weight: 700 !important;
    white-space: normal !important; /* å…è¨±æ›è¡Œ */
    word-break: break-all !important;
    display: block !important;
    padding-bottom: 1px !important; /* çµ¦åº•éƒ¨ç•™ä¸€é»é»å‘¼å¸ç©ºé–“ */
}

/* 5. ä¿®æ­£ FullCalendar é è¨­çš„æˆªæ–·å•é¡Œ */
.fc-v-event .fc-event-main-frame {
    flex-direction: column !important;
}

/* ç¾åŒ–ï¼šè®“æ ¼å­é‚Šæ¡†æ›´åœ“æ½¤ï¼Œå¢åŠ æ˜“è®€æ€§ */
.fc-v-event {
    border-radius: 6px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

<div id="loadingOverlay">
    <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-black text-indigo-600 tracking-widest text-sm animate-pulse">SYNCHRONIZING...</p>
</div>

<div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- é ‚éƒ¨å°èˆª -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg shadow-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-800">è¨ºæ‰€è¡Œæ”¿ç³»çµ± <span class="text-indigo-600">Pro</span></h1>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-tighter">Medical Appointment Scheduler</p>
            </div>
        </div>
        <div class="flex gap-2 mt-4 md:mt-0">
            <button onclick="init()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold transition">åˆ·æ–°åŒæ­¥</button>
            <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-100 transition">å¿«é€Ÿé ç´„</button>
        </div>
    </header>

    <!-- æœˆæ›†å®¹å™¨ -->
    <div class="bg-white p-2 md:p-4 rounded-[2.5rem] shadow-2xl shadow-slate-200/50 border border-white">
        <div id="calendar"></div>
    </div>
</div>

<!-- å½ˆçª— Modal -->
<div id="bookingModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex justify-center items-center p-4">
    <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
        <div class="bg-indigo-600 px-8 py-6 text-white flex justify-between items-center">
            <h3 class="text-xl font-bold">æ–°æ’ç¨‹ç™»è¨˜</h3>
            <button onclick="closeModal()" class="bg-indigo-500 hover:bg-indigo-400 w-8 h-8 rounded-full flex items-center justify-center transition">âœ•</button>
        </div>
        <form id="bookingForm" class="p-8 space-y-5">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-1">æ—¥æœŸ</label>
                    <input type="date" id="formDate" required class="w-full bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
                <div class="space-y-1">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-1">æ™‚é–“</label>
                    <input type="time" id="formTime" required class="w-full bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-1">æ‚£è€…å§“å</label>
                <input type="text" id="formName" required placeholder="è«‹è¼¸å…¥å§“å" class="w-full bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-1">è² è²¬äºº</label>
                    <select id="formTherapist" required class="w-full bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-1">æ²»ç™‚é …ç›®</label>
                    <select id="formItem" onchange="updatePrice()" required class="w-full bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm"></select>
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-1">å¯¦æ”¶è²»ç”¨</label>
                <input type="number" id="formFee" required class="w-full bg-indigo-50 border-none p-3 rounded-2xl font-bold text-indigo-700 outline-none">
            </div>
            <div class="space-y-1">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-1">å‚™è¨»è³‡è¨Š</label>
                <textarea id="formNotes" class="w-full bg-slate-50 border-none p-3 rounded-2xl h-20 outline-none text-sm" placeholder="ç‰¹æ®Šç‹€æ³èªªæ˜..."></textarea>
            </div>
            <button type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition">å®Œæˆé ç´„ç™»è¨˜</button>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz1Lkspl8yY3Jx1E_KcFxg583KYFKnMGQ4i4kQJanfsmhYHiX91q9hrGCErYmMYZspvRQ/exec"; 
    let calendar;
    let db = { appointments: [], therapists: [], treatments: [] };

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        showLoading(true);
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
            db = await resp.json();
            
            document.getElementById('formTherapist').innerHTML = db.therapists.map(t => `<option value="${t.å§“å}">${t.å§“å}</option>`).join('');
            document.getElementById('formItem').innerHTML = db.treatments.map(i => `<option value="${i.é …ç›®åç¨±}">${i.é …ç›®åç¨±}</option>`).join('');

            renderCalendar();
        } catch (e) {
            Swal.fire('Error', 'è³‡æ–™åŒæ­¥å¤±æ•—', 'error');
        }
        showLoading(false);
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (calendar) calendar.destroy();

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay,dayGridMonth' },
            locale: 'zh-tw',
            slotMinTime: '08:00:00',
            slotMaxTime: '21:00:00',
            allDaySlot: false,
            expandRows: true, // è®“æ©«æ¡¿é«˜åº¦è‡ªå‹•æ“´å±•
            height: 'auto',
            selectable: true,
            nowIndicator: true,
            handleWindowResize: true,
            windowResizeDelay: 100,
            slotEventOverlap: false,   // ç›¡é‡ä¸è¦è®“é ç´„é‡ç–Šï¼Œçœ‹å¾—æ›´æ¸…æ¥š
            eventMinHeight: 45,        // å¼·åˆ¶æœ€å°é«˜åº¦ (å–®ä½ px)
            slotDuration: '00:30:00',  // æ¯ä¸€æ ¼æ”¹ç‚º 30 åˆ†é˜ï¼Œæœƒæ‹‰é•·æœˆæ›†çš„å‚ç›´ç©ºé–“
            select: function(info) {
                openModal(info.startStr.split('T')[0], info.startStr.split('T')[1].substring(0,5));
                
            },
            eventClick: function(info) {
                const app = info.event.extendedProps;
                Swal.fire({
                    title: `æ‚£è€…: ${app.patient}`,
                    html: `<div class='text-left text-sm p-2 space-y-2 bg-slate-50 rounded-xl mt-4'>
                           <p><b>ğŸ©º é …ç›®ï¼š</b> ${app.item}</p>
                           <p><b>ğŸ‘¤ è² è²¬ï¼š</b> ${app.therapist}</p>
                           <p><b>ğŸ’° é‡‘é¡ï¼š</b> $${app.fee}</p>
                           <p><b>ğŸ“ å‚™è¨»ï¼š</b> ${app.notes || 'ç„¡'}</p>
                           </div>`,
                    showDenyButton: true,
                    confirmButtonText: 'âœ”ï¸ æ²»ç™‚å®Œæˆ',
                    denyButtonText: 'âŒ åˆªé™¤é ç´„',
                    confirmButtonColor: '#10b981',
                    denyButtonColor: '#ef4444'
                }).then(async (result) => {
                    if (result.isConfirmed) handleUpdate(app.id, 'å·²å®Œæˆ');
                    else if (result.isDenied) handleDelete(app.id);
                });
            },
            events: formatEvents(db.appointments)
            
        });
        calendar.render();
    }

function formatEvents(apps) {
    return apps.map(a => {
        const cleanDate = a.æ—¥æœŸ.replace(/\//g, '-');
        const cleanTime = a.æ™‚é–“.substring(0, 5);
        
        return {
            id: a.ID,
            // å°‡å§“åèˆ‡æ²»ç™‚å¸«æ”¾åœ¨åŒä¸€è¡Œï¼Œç”¨æ–œç·šéš”é–‹ï¼Œæ¸›å°‘å‚ç›´ç©ºé–“ä½”ç”¨
            title: `${a.æ‚£è€…å§“å} / ${a.æ²»ç™‚é …ç›® || a.é …ç›®} (${a.æ²»ç™‚å¸«})`, 
            start: `${cleanDate}T${cleanTime}:00`,
            end: `${cleanDate}T${calculateEndTime(cleanTime)}:00`,
            backgroundColor: a.ç‹€æ…‹ === 'å·²å®Œæˆ' ? '#10b981' : '#4f46e5',
            extendedProps: {
                patient: a.æ‚£è€…å§“å,
                therapist: a.æ²»ç™‚å¸«,
                item: a.é …ç›®,
                fee: a.è²»ç”¨,
                notes: a.å‚™è¨»,
                status: a.ç‹€æ…‹,
                id: a.ID
            }
        };
    });
}

    function calculateEndTime(startTime) {
        let [h, m] = startTime.split(':').map(Number);
        m += 50; 
        if (m >= 60) { h += 1; m -= 60; }
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    function openModal(date = '', time = '') {
        document.getElementById('bookingForm').reset();
        if(date) document.getElementById('formDate').value = date;
        if(time) document.getElementById('formTime').value = time;
        document.getElementById('bookingModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('bookingModal').classList.add('hidden'); }

    function updatePrice() {
        const item = db.treatments.find(i => i.é …ç›®åç¨± === document.getElementById('formItem').value);
        if (item) document.getElementById('formFee').value = item.é è¨­æ”¶è²»;
    }

    document.getElementById('bookingForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            date: document.getElementById('formDate').value,
            time: document.getElementById('formTime').value,
            name: document.getElementById('formName').value,
            therapist: document.getElementById('formTherapist').value,
            item: document.getElementById('formItem').value,
            fee: document.getElementById('formFee').value,
            notes: document.getElementById('formNotes').value
        };
        closeModal();
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', data }) });
        init();
    };

    async function handleUpdate(id, status) {
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id, status }) });
        init();
    }

    async function handleDelete(id) {
        if(!confirm('ç¢ºèªåˆªé™¤é ç´„ï¼Ÿ')) return;
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id, status }) });
        init();
    }

    function showLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
