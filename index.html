<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診所排程管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* --- 進階 Hoover 美化 --- */
        .fc-timegrid-slot {
            transition: background-color 0.2s;
            position: relative;
        }
        .fc-timegrid-slot:hover {
            background-color: #f0f9ff !important; /* 輕盈藍 */
        }
        .fc-timegrid-slot:hover::after {
            content: '+ 點擊預約';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            color: #0ea5e9;
            font-weight: bold;
            pointer-events: none;
        }
        /* 月曆事件樣式 */
        .fc-event {
            border: none !important;
            border-radius: 6px !important;
            padding: 2px 4px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

<div id="loadingOverlay">
    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="font-bold text-blue-600 tracking-widest">資料同步中...</p>
</div>

<div class="max-w-7xl mx-auto p-4">
    <div class="flex justify-between items-center mb-6 bg-white p-6 rounded-2xl shadow-sm">
        <h1 class="text-2xl font-black text-gray-800 tracking-tight">診所 <span class="text-blue-600">預約管理</span></h1>
        <button onclick="init()" class="text-sm bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200 transition">重新整理資料</button>
    </div>

    <div class="bg-white p-4 rounded-3xl shadow-xl border border-gray-100">
        <div id="calendar"></div>
    </div>
</div>

<!-- 預約視窗 (Modal) -->
<div id="bookingModal" class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex justify-center items-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in duration-200">
        <div class="bg-blue-600 p-6 text-white">
            <h3 class="text-xl font-bold">登記新預約</h3>
        </div>
        <form id="bookingForm" class="p-8 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <input type="date" id="formDate" required class="border p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
                <input type="time" id="formTime" required class="border p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <input type="text" id="formName" placeholder="患者姓名" required class="w-full border p-3 rounded-xl">
            <div class="grid grid-cols-2 gap-4">
                <select id="formTherapist" required class="border p-3 rounded-xl"></select>
                <select id="formItem" onchange="updatePrice()" required class="border p-3 rounded-xl"></select>
            </div>
            <input type="number" id="formFee" placeholder="收費金額" required class="w-full border p-3 rounded-xl bg-gray-50 font-bold text-blue-600">
            <textarea id="formNotes" placeholder="備註事項..." class="w-full border p-3 rounded-xl h-24"></textarea>
            
            <div class="flex space-x-2 pt-2">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">取消</button>
                <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">確認送出</button>
            </div>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz1Lkspl8yY3Jx1E_KcFxg583KYFKnMGQ4i4kQJanfsmhYHiX91q9hrGCErYmMYZspvRQ/exec";
    let calendar;
    let db = { appointments: [], therapists: [], treatments: [] };

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
            db = await resp.json();
            
            // 偵錯用：如果月曆還是空白，請在瀏覽器按 F12 看看有沒有印出資料
            console.log("預約資料庫內容:", db.appointments);

            const tSelect = document.getElementById('formTherapist');
            tSelect.innerHTML = db.therapists.map(t => `<option value="${t.姓名}">${t.姓名}</option>`).join('');
            
            const iSelect = document.getElementById('formItem');
            iSelect.innerHTML = db.treatments.map(i => `<option value="${i.項目名稱}">${i.項目名稱}</option>`).join('');

            renderCalendar();
        } catch (e) {
            Swal.fire('連線失敗', '請檢查 GAS 是否正確部署', 'error');
        }
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (calendar) calendar.destroy();

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            locale: 'zh-tw',
            slotMinTime: '08:00:00',
            slotMaxTime: '21:00:00',
            allDaySlot: false,
            selectable: true,
            // 點擊空白處
            select: function(info) {
                openModal(info.startStr.split('T')[0], info.startStr.split('T')[1].substring(0,5));
            },
            eventClick: function(info) {
                const app = info.event.extendedProps;
                Swal.fire({
                    title: `患者: ${app.patient}`,
                    html: `<div class="text-left text-sm">項目: ${app.item}<br>治療師: ${app.therapist}<br>金額: $${app.fee}<br>備註: ${app.notes || '無'}</div>`,
                    showDenyButton: true,
                    confirmButtonText: '已完成治療',
                    denyButtonText: '刪除預約'
                }).then(async (result) => {
                    if (result.isConfirmed) handleUpdate(app.id, '已完成');
                    else if (result.isDenied) handleDelete(app.id);
                });
            },
            events: formatEvents(db.appointments)
        });
        calendar.render();
    }

    function formatEvents(apps) {
        return apps.map(a => {
            // 格式化日期：將 2023/10/25 轉為 2023-10-25
            const cleanDate = a.日期.replace(/\//g, '-');
            const cleanTime = a.時間.substring(0, 5); // 確保是 HH:mm
            
            return {
                id: a.ID,
                title: `${a.患者姓名} (${a.治療師})`,
                start: `${cleanDate}T${cleanTime}:00`,
                // 結束時間設定為 50 分鐘後
                end: `${cleanDate}T${calculateEndTime(cleanTime)}:00`,
                backgroundColor: a.狀態 === '已完成' ? '#10b981' : '#3b82f6',
                extendedProps: {
                    patient: a.患者姓名,
                    therapist: a.治療師,
                    item: a.項目,
                    fee: a.費用,
                    notes: a.備註,
                    status: a.狀態,
                    id: a.ID
                }
            };
        });
    }

    function calculateEndTime(startTime) {
        let [h, m] = startTime.split(':').map(Number);
        m += 50; 
        if (m >= 60) { h += 1; m -= 60; }
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    function openModal(date, time) {
        document.getElementById('formDate').value = date;
        document.getElementById('formTime').value = time;
        document.getElementById('bookingModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('bookingModal').classList.add('hidden');
    }

    function updatePrice() {
        const item = db.treatments.find(i => i.項目名稱 === document.getElementById('formItem').value);
        if (item) document.getElementById('formFee').value = item.預設收費;
    }

    document.getElementById('bookingForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            date: document.getElementById('formDate').value,
            time: document.getElementById('formTime').value,
            name: document.getElementById('formName').value,
            therapist: document.getElementById('formTherapist').value,
            item: document.getElementById('formItem').value,
            fee: document.getElementById('formFee').value,
            notes: document.getElementById('formNotes').value
        };
        closeModal();
        document.getElementById('loadingOverlay').style.display = 'flex';
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', data }) });
        init();
    };

    async function handleUpdate(id, status) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id, status }) });
        init();
    }

    async function handleDelete(id) {
        if(!confirm('確認刪除預約？')) return;
        document.getElementById('loadingOverlay').style.display = 'flex';
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
        init();
    }
</script>
</body>
</html>
