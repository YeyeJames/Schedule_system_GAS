<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診所專業預約系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* 新增：滑鼠滑過時段的高亮特效 */
        .fc-timegrid-slot:hover {
            background-color: #e0e7ff !important; /* 淺藍色高亮 */
            cursor: cell;
        }
        /* 讓月曆事件更美觀 */
        .fc-event {
            border: none !important;
            padding: 2px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body class="bg-slate-50">

<div id="loadingOverlay" style="display:none;">
    <div class="bg-white p-5 rounded-lg shadow-xl flex items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mr-3"></div>
        <span class="font-bold text-gray-700">同步資料中...</span>
    </div>
</div>

<div class="max-w-7xl mx-auto p-4">
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
        <div>
            <h1 class="text-3xl font-black text-indigo-800">Clinic Pro</h1>
            <p class="text-slate-500 text-sm">自費治療排程系統</p>
        </div>
        <nav class="flex gap-2 mt-4 md:mt-0">
            <button onclick="showTab('calendar-view')" class="px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition">預約排程表</button>
            <button onclick="showTab('stats-view')" class="px-6 py-2 rounded-xl bg-white text-slate-600 font-bold border border-slate-200 hover:bg-slate-50 transition">數據報表</button>
        </nav>
    </header>

    <div id="calendar-view" class="tab-content active">
        <div class="bg-white p-4 md:p-8 rounded-3xl shadow-xl border border-slate-100">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- 統計介面 (保留之前的邏輯) -->
    <div id="stats-view" class="tab-content">
        <!-- 此處可放之前的統計代碼 -->
    </div>
</div>

<!-- 預約彈窗 (Modal) -->
<div id="bookingModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-50 p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200">
        <div class="bg-indigo-600 p-6">
            <h2 class="text-2xl font-bold text-white">建立新預約</h2>
        </div>
        <form id="bookingForm" class="p-8 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">預約日期</label>
                    <input type="date" id="formDate" required class="w-full border-slate-200 border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">起始時間</label>
                    <input type="time" id="formTime" required class="w-full border-slate-200 border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase">患者姓名</label>
                <input type="text" id="formName" placeholder="輸入姓名" required class="w-full border-slate-200 border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">負責治療師</label>
                    <select id="formTherapist" required class="w-full border-slate-200 border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">治療項目</label>
                    <select id="formItem" onchange="updatePrice()" required class="w-full border-slate-200 border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase">收費金額</label>
                <input type="number" id="formFee" required class="w-full border-slate-200 border p-3 rounded-xl bg-slate-50 font-mono font-bold text-indigo-600">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase">備註事項</label>
                <textarea id="formNotes" placeholder="例如：患者術後、需特別注意..." class="w-full border-slate-200 border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none h-20"></textarea>
            </div>
            
            <div class="flex space-x-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition">取消</button>
                <button type="submit" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">送出預約</button>
            </div>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwXiUJUt1cm1hnTPy57FAQ4hJpRqg5kFHJq02L4HkePHqc73HFDLWmYpvltRI2IVkPT2A/exec";
    let calendar;
    let rawData = { appointments: [], therapists: [], treatments: [] };

    document.addEventListener('DOMContentLoaded', initSystem);

    async function initSystem() {
        showLoading(true);
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
            rawData = await resp.json();
            
            document.getElementById('formTherapist').innerHTML = '<option value="">選擇治療師</option>' + 
                rawData.therapists.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            document.getElementById('formItem').innerHTML = '<option value="">選擇項目</option>' + 
                rawData.treatments.map(i => `<option value="${i.name}">${i.name}</option>`).join('');

            renderCalendar();
        } catch (e) {
            console.error(e);
            Swal.fire('連線錯誤', '請確認 GAS 部署是否正確', 'error');
        }
        showLoading(false);
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (calendar) calendar.destroy();

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'zh-tw',
            slotMinTime: '08:00:00',
            slotMaxTime: '22:00:00',
            expandRows: true,
            allDaySlot: false,
            navLinks: true,
            selectable: true,
            selectMirror: true,
            // 點擊空白處新增預約
            select: function(info) {
                const date = info.startStr.split('T')[0];
                const time = info.startStr.split('T')[1]?.substring(0,5) || "09:00";
                openModal(date, time);
            },
            // 點擊事件查看
            eventClick: function(info) {
                const app = info.event.extendedProps;
                Swal.fire({
                    title: `<span class="text-indigo-600">${app.patient}</span>`,
                    html: `
                        <div class="text-left text-sm space-y-2">
                            <p><b>項目：</b> ${app.item}</p>
                            <p><b>治療師：</b> ${app.therapist}</p>
                            <p><b>收費：</b> $${app.fee}</p>
                            <p><b>備註：</b> ${app.notes || '無'}</p>
                            <p><b>狀態：</b> <span class="px-2 py-0.5 rounded bg-amber-100 text-amber-700">${app.status}</span></p>
                        </div>
                    `,
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: '設為完成',
                    denyButtonText: '刪除預約',
                    cancelButtonText: '關閉'
                }).then(async (result) => {
                    if (result.isConfirmed) updateAppStatus(app.id, '已完成');
                    else if (result.isDenied) deleteApp(app.id);
                });
            },
            events: formatEvents(rawData.appointments)
        });
        calendar.render();
    }

    // 格式化資料，確保預約顯示在月曆上
    function formatEvents(apps) {
        return apps.map(a => {
            // 處理日期格式 (確保格式為 YYYY-MM-DD)
            const dateStr = a.日期.includes('T') ? a.日期.split('T')[0] : a.日期;
            const startISO = `${dateStr}T${a.時間}`;
            
            return {
                id: a.ID,
                title: `${a.患者姓名} | ${a.項目}`,
                start: startISO,
                // 預設 50 分鐘療程，留 10 分鐘緩衝
                end: moment(startISO).add(50, 'minutes').format('YYYY-MM-DDTHH:mm:ss'), 
                backgroundColor: getEventColor(a.狀態),
                extendedProps: {
                    patient: a.患者姓名,
                    therapist: a.治療師,
                    item: a.項目,
                    status: a.狀態,
                    fee: a.費用,
                    notes: a.備註,
                    id: a.ID
                }
            };
        }).filter(e => !isNaN(new Date(e.start).getTime())); // 過濾掉無效日期
    }

    function getEventColor(status) {
        if (status === '已完成') return '#10b981';
        if (status === '請假') return '#f59e0b';
        return '#6366f1';
    }

    function openModal(date = '', time = '') {
        document.getElementById('bookingForm').reset();
        document.getElementById('formDate').value = date;
        document.getElementById('formTime').value = time;
        document.getElementById('bookingModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('bookingModal').classList.add('hidden');
    }

    function updatePrice() {
        const item = rawData.treatments.find(i => i.name === document.getElementById('formItem').value);
        if (item) document.getElementById('formFee').value = item.price;
    }

    document.getElementById('bookingForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            date: document.getElementById('formDate').value,
            time: document.getElementById('formTime').value,
            name: document.getElementById('formName').value,
            therapist: document.getElementById('formTherapist').value,
            item: document.getElementById('formItem').value,
            fee: document.getElementById('formFee').value,
            notes: document.getElementById('formNotes').value
        };

        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', data: data }) });
        closeModal();
        await initSystem();
        showLoading(false);
        Swal.fire('成功', '預約已同步至雲端', 'success');
    };

    async function updateAppStatus(id, status) {
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id: id, status: status }) });
        await initSystem();
        showLoading(false);
    }

    async function deleteApp(id) {
        const result = await Swal.fire({ title: '確定刪除？', text: "刪除後無法復原", icon: 'warning', showCancelButton: true });
        if (!result.isConfirmed) return;
        
        showLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) });
        await initSystem();
        showLoading(false);
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if (tabId === 'calendar-view' && calendar) calendar.render();
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }
</script>
<!-- 引入 Moment.js 方便處理時間運算 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</body>
</html>
